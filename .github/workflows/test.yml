name: Comprehensive Security CI Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: narsi421/juice-shop
  SONAR_PROJECT_KEY: juice-shop
  SONAR_PROJECT_NAME: juiceShop
  SONAR_URL: ${{ secrets.SONAR_URL }}
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_ENGAGEMENT_ID: 3
  PROJECT_NAME: ${{ github.event.repository.name }}

jobs:
  security-pipeline:
    runs-on: self-hosted

    steps:
    # -------------------------------------------------
    # Checkout and Setup
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Node.js 21
      uses: actions/setup-node@v4
      with:
        node-version: '21'

    - name: Add SonarScanner to PATH
      run: echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

    # -------------------------------------------------
    # SonarQube SAST Analysis
    # -------------------------------------------------
    - name: SonarQube Scan
      run: |
        sonar-scanner \
          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
          -Dsonar.projectName=${SONAR_PROJECT_NAME} \
          -Dsonar.sources=. \
          -Dsonar.host.url=${SONAR_URL} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    - name: Export SonarQube Vulnerabilities
      run: |
        curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
          "${SONAR_URL}/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&types=VULNERABILITY&ps=500" \
          -o sonar-vulnerabilities.json

    - name: Export SonarQube Security Hotspots
      run: |
        curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
          "${SONAR_URL}/api/hotspots/search?projectKey=${SONAR_PROJECT_KEY}&status=TO_REVIEW,REVIEWED&ps=500" \
          -o sonar-hotspots.json

    # -------------------------------------------------
    # Build Docker Image
    # -------------------------------------------------
    - name: Build Docker Image for Scanning
      run: docker build -t ${IMAGE_NAME}:ci-scan .

    # -------------------------------------------------
    # Trivy Scan: SBOM with Vulnerabilities
    # -------------------------------------------------
    - name: Trivy SBOM Generation with Vulnerabilities
      run: |
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v $HOME/.trivy-cache:/root/.cache/ \
          -v ${{ github.workspace }}:/root/scan \
          aquasec/trivy:0.50.1 image \
          --scanners vuln \
          --format cyclonedx \
          --output /root/scan/sbom-with-vulns.json \
          ${IMAGE_NAME}:ci-scan
        
        # Also generate JSON format for DefectDojo compatibility
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v $HOME/.trivy-cache:/root/.cache/ \
          -v ${{ github.workspace }}:/root/scan \
          aquasec/trivy:0.50.1 image \
          --scanners vuln \
          --format json \
          --output /root/scan/trivy-vuln-report.json \
          ${IMAGE_NAME}:ci-scan

    - name: Validate SBOM Format
      run: |
        echo "Validating CycloneDX SBOM with vulnerabilities..."
        grep -q '"bomFormat"' sbom-with-vulns.json
        grep -q '"specVersion"' sbom-with-vulns.json
        grep -q '"vulnerabilities"' sbom-with-vulns.json || echo "Note: No vulnerabilities section found"
        echo "âœ“ SBOM format validated"

    # -------------------------------------------------
    # Upload Results to DefectDojo
    # -------------------------------------------------
    - name: Import Trivy Scan to DefectDojo
      run: |
        curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=Trivy Scan" \
          -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
          -F "test_title=Trivy - ${{ github.ref_name }}" \
          -F "file=@trivy-vuln-report.json" \
          -F "active=true" \
          -F "verified=true"

    - name: Import SonarQube Vulnerabilities to DefectDojo
      run: |
        curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=SonarQube Scan" \
          -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
          -F "test_title=SonarQube Vulns - ${{ github.ref_name }}" \
          -F "file=@sonar-vulnerabilities.json" \
          -F "active=true" \
          -F "verified=true"

    # -------------------------------------------------
    # Upload SBOM to Dependency-Track
    # -------------------------------------------------
    - name: Upload SBOM to Dependency-Track
      run: |
        curl -X POST "${{ secrets.DEPENDENCYTRACK_URL }}/api/v1/bom" \
          -H "X-Api-Key: ${{ secrets.DEPENDENCYTRACK_API_KEY }}" \
          -F "autoCreate=true" \
          -F "projectName=${PROJECT_NAME}" \
          -F "projectVersion=${{ github.ref_name }}" \
          -F "bom=@sbom-with-vulns.json"

    # -------------------------------------------------
    # Archive Artifacts
    # -------------------------------------------------
    - name: Archive Security Scan Results
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          trivy-vuln-report.json
          sbom-with-vulns.json
          sonar-vulnerabilities.json
          sonar-hotspots.json

    # -------------------------------------------------
    # Cleanup
    # -------------------------------------------------
    - name: Cleanup CI Image
      run: docker rmi ${IMAGE_NAME}:ci-scan || true
