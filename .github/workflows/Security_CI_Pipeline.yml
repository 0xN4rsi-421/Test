name: Security CI Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: narsi421/juice-shop
  SONAR_PROJECT_KEY: juice-shop
  SONAR_PROJECT_NAME: juiceShop
  SONAR_URL: ${{ secrets.SONAR_URL }}
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_ENGAGEMENT_ID: 3

jobs:
  security-pipeline:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Node.js 21
      uses: actions/setup-node@v4
      with:
        node-version: '21'

    - name: Add SonarScanner to PATH
      run: echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

    # -------------------------------
    # SonarQube analysis
    # -------------------------------
    - name: SonarQube Scan
      run: |
        sonar-scanner \
          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
          -Dsonar.projectName=${SONAR_PROJECT_NAME} \
          -Dsonar.sources=. \
          -Dsonar.host.url=${SONAR_URL} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    # -------------------------------
    # Export vulnerabilities (correct endpoint)
    # -------------------------------
    - name: Export SonarQube Vulnerabilities
      run: |
        curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
          "${SONAR_URL}/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&types=VULNERABILITY&ps=500" \
          -o sonar-vulnerabilities.json

    # -------------------------------
    # Export security hotspots (correct endpoint)
    # -------------------------------
    - name: Export SonarQube Security Hotspots
      run: |
        curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
          "${SONAR_URL}/api/hotspots/search?projectKey=${SONAR_PROJECT_KEY}&status=TO_REVIEW,REVIEWED&ps=500" \
          -o sonar-hotspots.json

    # -------------------------------
    # Build image for Trivy
    # -------------------------------
    - name: Build Docker Image for Scan
      run: docker build -t ${IMAGE_NAME}:ci-scan .

    # -------------------------------
    # Trivy scan
    # -------------------------------
    - name: Trivy Vulnerability Scan
      run: |
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v $HOME/.trivy-cache:/root/.cache/ \
          -v ${{ github.workspace }}:/root/scan \
          aquasec/trivy image \
          --scanners vuln \
          --format json \
          --output /root/scan/trivy-vuln-report.json \
          ${IMAGE_NAME}:ci-scan

    # -------------------------------
    # Import Trivy
    # -------------------------------
    - name: Import Trivy to DefectDojo
      run: |
        curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=Trivy Scan" \
          -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
          -F "test_title=Trivy - ${{ github.ref_name }}" \
          -F "file=@trivy-vuln-report.json" \
          -F "active=true" \
          -F "verified=true"

    # -------------------------------
    # Import Sonar vulnerabilities (as before)
    # -------------------------------
    - name: Import SonarQube Vulnerabilities to DefectDojo
      run: |
        curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=SonarQube Scan" \
          -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
          -F "test_title=SonarQube Vulns - ${{ github.ref_name }}" \
          -F "file=@sonar-vulnerabilities.json" \
          -F "active=true" \
          -F "verified=true"

    # -------------------------------
    # Archive artifacts
    # -------------------------------
    - name: Archive JSON Reports
      uses: actions/upload-artifact@v4
      with:
        name: scan-results
        path: |
          trivy-vuln-report.json
          sonar-vulnerabilities.json
          sonar-hotspots.json

    - name: Cleanup CI Image
      run: docker rmi ${IMAGE_NAME}:ci-scan || true
